<%@ page import="java.io.*,java.util.*"%>
<%@ page import="java.text.*"%>
<%@ page import="java.net.*"%>
<%@ page import="com.newgen.custom.wfdesktop.xmlapi.*" %>
<%@ page import="com.newgen.custom.wfdesktop.util.*" %>
<%@ page import="com.newgen.custom.wfdesktop.util.xmlapi.*" %>
<%@ page import="com.newgen.custom.wfdesktop.exception.*" %>
<%@ page import="com.newgen.custom.*" %>
<%@ include file="../TWC_Specific/Log.process"%>
<%@ page import="java.io.FileOutputStream" %>
<%@ page import="java.text.Format" %>
<%@ page import="java.text.SimpleDateFormat" %>
<%@page import="ISPack.ISUtil.JPISException"%>
<%@page import="ISPack.CPISDocumentTxn"%>
<%@page import="ISPack.ISUtil.JPDBRecoverDocData"%>
<%@page import="ISPack.ISUtil.JPISIsIndex"%>
<jsp:useBean id="customSession" class="com.newgen.custom.wfdesktop.session.WFCustomSession" scope="session"/>
<%@page contentType="text/html" pageEncoding="UTF-8"%>

<%!public static String readFileFromServer(String filename)
	{	
		String xmlReturn="";
		try {
			File file = new File(filename);
			FileReader fileReader = new FileReader(file);
			BufferedReader bufferedReader = new BufferedReader(fileReader);
			StringBuffer stringBuffer = new StringBuffer();
			String line;
			while ((line = bufferedReader.readLine()) != null) {
				stringBuffer.append(line);
				stringBuffer.append("\n");
			}
			fileReader.close();
			logger.info("Contents of file:");
			xmlReturn = stringBuffer.toString();
			//logger.info("file content"+xmlReturn);
			
		} catch (IOException e) {
			e.printStackTrace();
		}
		return xmlReturn;
	
	
	}
	
	public static String convertToTitleCaseIteratingChars(String text) {
		if (text == null || text.isEmpty()) {
			return text;
		}

		StringBuilder converted = new StringBuilder();

		boolean convertNext = true;
		for (char ch : text.toCharArray()) {
			if (Character.isSpaceChar(ch)) {
				convertNext = true;
			} else if (convertNext) {
				ch = Character.toTitleCase(ch);
				convertNext = false;
			} else {
				ch = Character.toLowerCase(ch);
			}
			converted.append(ch);
		}

		return converted.toString();
	}

	
	public static String writeFileFromServer(String filename,String oldString)
	{
		 String newString="";	
		logger.info("\n Inside writeFileFromServer function");
		
		try {
			 newString = oldString.replaceAll("<p>", " ");
			 newString = newString.replaceAll("</p>"," ");
            //Rewriting the input text file with newString
			
            FileOutputStream out = new FileOutputStream(filename);
			out.write(newString.getBytes());
			out.close();
			
			logger.info("after writing into file"+newString);
				
		} catch (IOException e) {
			logger.info("The Exception is "+e.getMessage());
			e.printStackTrace();
		}
			return newString;
	}	
	
	public String getServerDateTime ()
		{
		 Date date = new Date();
		 DateFormat dateFormatScanDateTime = new SimpleDateFormat("dd/MM/yyyy");		   
		 String tempScanDate = dateFormatScanDateTime.format(date);
		 
		 return tempScanDate;
		}
		
	 public void deleteLocalDocument(String sFileName)
	 {
		logger.info("Delete File Path: "+sFileName);
		try{
			File file = new File(sFileName);
			if(file.delete()){
				logger.info(file.getName() + " is deleted!");
			}else{
				logger.info("\n Delete operation is failed.");
			}
		}catch(Exception e){
			logger.info("\n Exception in deleteLocalDocument:-"+e.getMessage());
		}
	}	
		
	String getTagValue(String sXML, String sTagName) 
	{
		String sTagValue = "";
		String sStartTag = "<" + sTagName + ">";
		String sEndTag = "</" + sTagName + ">";
		if (sXML.indexOf("<" + sTagName + ">") != -1) {
			sTagValue = sXML.substring(sXML.indexOf(sStartTag) + sStartTag.length(), sXML.indexOf(sEndTag));
		} else {
			if (sTagName.equals("noOfRecordsFetched")) {
				sTagValue = "0";
			}
		}
		return sTagValue;
    }
	
	public String SearchExistingDoc(String pid, String FrmType, String sCabname, String sSessionId, String sJtsIp, int iJtsPort_int, String sFilepath,String volumeid,String FolderIndex) {
		
				try {
					
						short iJtsPort = (short) iJtsPort_int;
						String filepath = sFilepath;
						
						File newfile = new File(filepath);
						String name = newfile.getName();
						String ext = "";
						String sMappedInputXml="";
						if (name.contains(".")) {
							ext = name.substring(name.lastIndexOf("."), name.length());
						}
						JPISIsIndex ISINDEX = new JPISIsIndex();
						JPDBRecoverDocData JPISDEC = new JPDBRecoverDocData();
						String strDocumentPath = sFilepath;
						File processFile = null;
						long lLngFileSize = 0L;
						processFile = new File(strDocumentPath);
						
						lLngFileSize = processFile.length();
						String lstrDocFileSize = "";
						lstrDocFileSize = Long.toString(lLngFileSize);
						
						String createdbyappname = "";
						createdbyappname = ext.replaceFirst(".", "");
						Short volIdShort = Short.valueOf(volumeid);
						
						if (lLngFileSize != 0L)
						{
							CPISDocumentTxn.AddDocument_MT(null, sJtsIp, iJtsPort, sCabname, volIdShort.shortValue(), strDocumentPath, JPISDEC, "", ISINDEX);
							
						}  
									 
							sMappedInputXml="<?xml version=\"1.0\"?>"+
										"<NGOAddDocument_Input>"+ 
										"<Option>NGOAddDocument</Option>"+ 
										"<CabinetName>"+sCabname+"</CabinetName>"+ 
										"<UserDBId>"+sSessionId+"</UserDBId>" + 
										"<GroupIndex>0</GroupIndex>" +
										"<VersionFlag>Y</VersionFlag>" +
										"<ParentFolderIndex>"+FolderIndex+"</ParentFolderIndex>" +
										"<DocumentName>"+FrmType+"</DocumentName>"+
										"<CreatedByAppName>"+createdbyappname+"</CreatedByAppName>" +
										"<Comment>"+FrmType+"</Comment>" +
										"<VolumeIndex>"+volumeid+"</VolumeIndex>"+
										"<FilePath>"+strDocumentPath+"</FilePath>"+
										"<ISIndex>"+ISINDEX.m_nDocIndex+"#"+ISINDEX.m_sVolumeId+"</ISIndex>" + 
										"<NoOfPages>1</NoOfPages>" + 
										"<DocumentType>N</DocumentType>" +
										"<DocumentSize>"+lstrDocFileSize+"</DocumentSize>" +
										"</NGOAddDocument_Input>";
						
						
						logger.info("Document Addition sInputXML: "+sMappedInputXml);
						String sOutputXml = WFCustomCallBroker.execute(sMappedInputXml, sJtsIp, iJtsPort, 1);
						logger.info("Document Addition sOutputXml: "+sOutputXml);
						String status_D = getTagValue(sOutputXml, "Status");
						if(status_D.equalsIgnoreCase("0")){
							//deleteLocalDocument(sFilepath);
							return sOutputXml;
						} else {
							return "Error in Document Addition";
						}
					} catch (JPISException e) {
						return "Error in Document Addition at Volume";
					} catch (Exception e) {
						return "Exception Occurred in Document Addition";
					}
		}
		
  public static String convertLessThanOneThousand(int number) {
    String soFar;
	String numNames[] = {""," one"," two"," three"," four"," five"," six"," seven"," eight"," nine"," ten"," eleven"," twelve"," thirteen"," fourteen"," fifteen"," sixteen"," seventeen"," eighteen"," nineteen"};
	String tensNames[] = {""," ten"," twenty"," thirty"," forty"," fifty"," sixty"," seventy"," eighty"," ninety"};

    if (number % 100 < 20){
      soFar = numNames[number % 100];
      number /= 100;
    }
    else {
      soFar = numNames[number % 10];
      number /= 10;

      soFar = tensNames[number % 10] + soFar;
      number /= 10;
    }
    if (number == 0) return soFar;
    return numNames[number] + " hundred" + soFar;
  }
  
  public static String convert(double number) {
    // 0 to 999 999 999 999
    if (number == 0) { return "zero"; }
	int numb=(int) number;
    String snumber = Long.toString(numb);

    // pad with "0"
    String mask = "000000000000";
    DecimalFormat df = new DecimalFormat(mask);
    snumber = df.format(number);

    // XXXnnnnnnnnn
    int billions = Integer.parseInt(snumber.substring(0,3));
    // nnnXXXnnnnnn
    int millions  = Integer.parseInt(snumber.substring(3,6));
    // nnnnnnXXXnnn
    int hundredThousands = Integer.parseInt(snumber.substring(6,9));
    // nnnnnnnnnXXX
    int thousands = Integer.parseInt(snumber.substring(9,12));

    String tradBillions;
    switch (billions) {
    case 0:
      tradBillions = "";
      break;
    case 1 :
      tradBillions = convertLessThanOneThousand(billions)
      + " billion ";
      break;
    default :
      tradBillions = convertLessThanOneThousand(billions)
      + " billion ";
    }
    String result =  tradBillions;

    String tradMillions;
    switch (millions) {
    case 0:
      tradMillions = "";
      break;
    case 1 :
      tradMillions = convertLessThanOneThousand(millions)
         + " million ";
      break;
    default :
      tradMillions = convertLessThanOneThousand(millions)
         + " million ";
    }
    result =  result + tradMillions;

    String tradHundredThousands;
    switch (hundredThousands) {
    case 0:
      tradHundredThousands = "";
      break;
    case 1 :
      tradHundredThousands = "one thousand ";
      break;
    default :
      tradHundredThousands = convertLessThanOneThousand(hundredThousands)
         + " thousand ";
    }
    result =  result + tradHundredThousands;

    String tradThousand;
    tradThousand = convertLessThanOneThousand(thousands);
    result =  result + tradThousand;

    // remove extra spaces!
    return result.replaceAll("^\\s+", "").replaceAll("\\b\\s{2,}\\b", " ");
  }
	
%>
<%
	logger.info("\nInside TemplateGeneration.jsp\n");
	try
	{
		String winame = request.getParameter("winame");
		String username= customSession.getUserName();
		String sJtsIp = customSession.getJtsIp();
		int iJtsPort = customSession.getJtsPort();
		String sCabName=customSession.getEngineName();	
		String sSessionId = customSession.getDMSSessionId();
		String sMappOutPutXML="";
		String params ="";
		String pdfTemplatePath = "";
		String ExternalTable = "";
		String Ext_ColumnName = "";
		String generateddocPath = "";
		String masterfacilitylimit="";
		String accounttobedebitedforfee = "";
		String pdfName ="template";
		String dynamicPdfName =  winame+ pdfName + ".doc";
		String mydate = getServerDateTime();
		String Product_Structure_Level_Condition="";
		String Commission="";
		String Facility_ColumnName="";
		String FacilityMasterTable="";
		String facility_details="";
		String natureoffacility="";
		String Facility_GridTable="";
		String Facility_Grid="";
		String facility_GridColName="";
		String tempRowvalues="";
		WFCustomXmlList objWorkList=null;
		WFCustomXmlResponse objWFCustomXmlResponse=null;
		String subXML="";
		String splittemp[]=null;
		String replacedString="";
		String General_Conditions_GridColName="";
		String External_Limit_ColName = "";
		String general_details="";
		String external_details="";
		int total_record_extlimit=0;
		int total_record_gen=0;
		int total_record_security=0;
		int totalRecord=0;
		String Security_Doc_ColName="";
		String security_details="";
		int values1=0;
		LinkedHashMap<String,String> mapCheckfacility = new LinkedHashMap<String,String>();
		LinkedHashMap<String,String> mapfacility = new LinkedHashMap<String,String>();
		LinkedHashMap<String,String> mapgeneral = new LinkedHashMap<String,String>();
		LinkedHashMap<String,String> mapexternal = new LinkedHashMap<String,String>();
		LinkedHashMap<String,String> mapsecurity = new LinkedHashMap<String,String>();
		Map<String,String> mapCheck = new HashMap<String,String>();
		String twc_temp="";
		String docxml="";
		String documentindex="";
		String doctype="";
		String Itemindex="";
		String OutputWriteString="";
		
		//Reading path from property file
		Properties properties = new Properties();
		try
		{
		
			properties.load(new FileInputStream(System.getProperty("user.dir")+ System.getProperty("file.separator")+ "RakBankConfig.properties"));
			
			String tempDir = System.getProperty("user.dir");
			
			String FrmType = properties.getProperty("DocumentName");
			String volumeid = properties.getProperty("VolumeID");
			
			pdfTemplatePath = tempDir + properties.getProperty("TWC_TEMPLATE_HTML_PATH");
			
			ExternalTable = properties.getProperty("External_Table");
			Ext_ColumnName = properties.getProperty("Column_Name");
			String ColumnNameArray[] = Ext_ColumnName.split(",");
			
			FacilityMasterTable = properties.getProperty("Facility_Master_Table");
			Facility_ColumnName = properties.getProperty("Facility_Master_Col_Name");
			String FacilityColArray[] = Facility_ColumnName.split(",");
			
			Facility_GridTable = properties.getProperty("Facility_Grid_Table");
			facility_GridColName = properties.getProperty("Facility_Grid_Col_Name");
			String FacilityGridColumn[] = facility_GridColName.split(",");
			
			General_Conditions_GridColName = properties.getProperty("General_Conditions_Grid_Col_Name");
			String GeneralGridCol[] = General_Conditions_GridColName.split(",");
			String GeneralTable = properties.getProperty("General_Table");
			
			External_Limit_ColName = properties.getProperty("External_Limit_Col_Name");
			String ExternalGridCol[] = External_Limit_ColName.split(",");
			String ExternalGrid= properties.getProperty("External_Grid");
			
			Security_Doc_ColName = properties.getProperty("Security_Doc_Col_Name");
			String SecurityGridCol[] = Security_Doc_ColName.split(",");
			String SecurityGrid = properties.getProperty("Security_Document_Table");
			
			generateddocPath = properties.getProperty("TWC_GENERTATED_HTML_PATH");//Get the loaction of the path where generated template will be saved
			generateddocPath += dynamicPdfName;
			generateddocPath = tempDir + generateddocPath;//Complete path of generated document
			logger.info("\nTemplate Doc generateddocPath :" + generateddocPath);
			
			sMappOutPutXML = readFileFromServer(pdfTemplatePath);
			//logger.info("replaced string nikita"+sMappOutPutXML);
			replacedString = sMappOutPutXML.replaceAll("&lt;","<");
			replacedString = replacedString.replaceAll("&gt;",">");
			replacedString = replacedString.replaceAll("â€œ","");  
			replacedString = replacedString.replaceAll("â€?"," "); 
			replacedString = replacedString.replaceAll("&amp;","&");   
			replacedString = replacedString.replaceAll("â€™","'"); 
			
			//logger.info("\nOutput XML Customer Integration Call by Nikita:\n"+sMappOutPutXML);		
			String queryExtTable = "select" +" "+ Ext_ColumnName +" "+"from" +" "+ExternalTable+" "+ "with (nolock) where wi_name=:WI_NAME";
			logger.info("\nqueryExtTable:\n"+queryExtTable);
			params = "WI_NAME=="+winame;
			
			String inputXML4 = "<?xml version='1.0'?><APSelectWithNamedParam_Input><Option>APSelectWithNamedParam</Option><Query>" + queryExtTable + "</Query><Params>"+params+"</Params><EngineName>" + sCabName + "</EngineName><SessionId>" + sSessionId + "</SessionId></APSelectWithNamedParam_Input>";
			
			 logger.info("\n InputXML to get Customer Name-->"+inputXML4);
			String outputXML4 = WFCustomCallBroker.execute(inputXML4, sJtsIp, iJtsPort, 1);
			 logger.info("\n outputXML to get Customer Name-->"+outputXML4);
			
			WFCustomXmlResponse xmlParserData4=new WFCustomXmlResponse();
			xmlParserData4.setXmlString((outputXML4));
			String mainCodeValue4 = xmlParserData4.getVal("MainCode");
			
			WFCustomXmlResponse objXmlParser4=null;
			
			if(mainCodeValue4.equals("0"))
			{
			    Itemindex = xmlParserData4.getVal(ColumnNameArray[0]);
				logger.info("Item Index is"+Itemindex);
				for(int j = 0; j < ColumnNameArray.length; ++j)
				{	
					mapCheck.put(ColumnNameArray[j],xmlParserData4.getVal(ColumnNameArray[j]));	
				}
				logger.info("Fetching Keys and corresponding [Multiple] Values");
				for (Map.Entry<String,String> entry : mapCheck.entrySet()) 
				{
					String key = entry.getKey();
					String values = entry.getValue();
					logger.info("Ext Column Key = " + key);
					logger.info("Ext Column values"+values);
					replacedString = replacedString.replaceAll("<&"+key+"&>",values);
				}
			}
			
			else
			{
				out.clear();
				//out.print("-4");
				out.print("ERROR - Error while fetching the data from security document table");
				return;
			}
			
			String queryGeneralTable = "select " +" "+ General_Conditions_GridColName +" "+"from"+" " +GeneralTable +" "+"with (nolock) where WINAME=:WI_NAME";
			logger.info("\nqueryGeneralTable:\n"+queryGeneralTable);
			params = "WI_NAME=="+winame;
			
			String inputXML1 = "<?xml version='1.0'?><APSelectWithNamedParam_Input><Option>APSelectWithNamedParam</Option><Query>" + queryGeneralTable + "</Query><Params>"+params+"</Params><EngineName>" + sCabName + "</EngineName><SessionId>" + sSessionId + "</SessionId></APSelectWithNamedParam_Input>";
			
			 logger.info("\n InputXML to get general conditions-->"+inputXML1);
			String outputXML1 = WFCustomCallBroker.execute(inputXML1, sJtsIp, iJtsPort, 1);
			 logger.info("\n outputXML to get general conditions-->"+outputXML1);
			
			WFCustomXmlResponse xmlParserData1=new WFCustomXmlResponse();
			xmlParserData1.setXmlString((outputXML1));
			String mainCodeValue1 = xmlParserData1.getVal("MainCode");
			logger.info("mainCodeValue1--"+mainCodeValue1);
			total_record_gen = Integer.parseInt(xmlParserData1.getVal("TotalRetrieved"));
			logger.info("total_record_gen---"+total_record_gen);
			
			WFCustomXmlResponse objXmlParser1=null;
			
			if(mainCodeValue1.equals("0") && total_record_gen>0)
			{
				objWorkList = xmlParserData1.createList("Records","Record"); 
				int p=1;
				general_details +="<ul style='list-style:none;list-style-image:none;list-style-type:none;'>";
				for(objWorkList.reInitialize(true);objWorkList.hasMoreElements(true);objWorkList.skip(true))
				{
					general_details +="<body style=font-family:verdana;font-size:"+13+">";
					subXML = objWorkList.getVal("Record");
					objWFCustomXmlResponse = new WFCustomXmlResponse(subXML);	
					for(int j = 0; j < GeneralGridCol.length; ++j)
					{		
						mapgeneral.put(GeneralGridCol[j],objWFCustomXmlResponse.getVal(GeneralGridCol[j]));	
					}
						
					for (Map.Entry<String,String> entry : mapgeneral.entrySet()) 
					{
						String key = entry.getKey();
						String values = entry.getValue();
						logger.info("key for general--------->"+key);
						logger.info("values for general------->"+values);
						if(!(values==null || values.equals("")))
						{
								
							if(p>=1)
							{
								general_details += "<p><b>"+p+" . </b>"+values+"</p><br/>";
								p++;
								break;
							}
								
								
						}
					}
					general_details +="</ul>";
				}
				
				
			}
			
			else if(mainCodeValue1.equals("0") && total_record_gen==0)
			{
				general_details="";
			}
			
			else
			{
				out.clear();
				out.print("ERROR - Error while fetching the data from general conditions table");
				return;
			}
			
			
			String queryExternalLimitTable = "select " +" "+ External_Limit_ColName +" "+"from"+" " +ExternalGrid +" "+"with (nolock) where WINAME=:WI_NAME";
			logger.info("\nqueryExternalLimitTable:\n"+queryExternalLimitTable);
			params = "WI_NAME=="+winame;
			
			String inputXML2 = "<?xml version='1.0'?><APSelectWithNamedParam_Input><Option>APSelectWithNamedParam</Option><Query>" + queryExternalLimitTable + "</Query><Params>"+params+"</Params><EngineName>" + sCabName + "</EngineName><SessionId>" + sSessionId + "</SessionId></APSelectWithNamedParam_Input>";
			
			 logger.info("\n InputXML to get external conditions-->"+inputXML2);
			String outputXML2 = WFCustomCallBroker.execute(inputXML2, sJtsIp, iJtsPort, 1);
			 logger.info("\n outputXML to get external conditions-->"+outputXML2);
			
			WFCustomXmlResponse xmlParserData2=new WFCustomXmlResponse();
			xmlParserData2.setXmlString((outputXML2));
			String mainCodeValue2 = xmlParserData2.getVal("MainCode");
			total_record_extlimit = Integer.parseInt(xmlParserData2.getVal("TotalRetrieved"));
			
			WFCustomXmlResponse objXmlParser2=null;
			
			if(mainCodeValue2.equals("0") && total_record_extlimit>0)
			{
				objWorkList = xmlParserData2.createList("Records","Record"); 
				int p=1;
				for(objWorkList.reInitialize(true);objWorkList.hasMoreElements(true);objWorkList.skip(true))
				{
					external_details +="<body style=font-family:verdana;font-size:"+13+">";	
					subXML = objWorkList.getVal("Record");
					objWFCustomXmlResponse = new WFCustomXmlResponse(subXML);	
					for(int j = 0; j < ExternalGridCol.length; ++j)
					{		
						mapexternal.put(ExternalGridCol[j],objWFCustomXmlResponse.getVal(ExternalGridCol[j]));	
					}
						
					for (Map.Entry<String,String> entry : mapexternal.entrySet()) 
					{
						String key = entry.getKey();
						String values = entry.getValue();
						logger.info("key for external--------->"+key);
						logger.info("values for external------->"+values);
						if(!(values==null || values.equals("")))
						{
							if(p>=1)
							{
								external_details += "<br/>&#09;<p><b>"+p+"</b>. "+values+"</p><br/>";
								p++;
								break;
							}
						}
					}
				}
				external_details += "<ul style='list-style:none;list-style-image:none;list-style-type:none;'><br><p><b>"+p+". </b>immediately inform the Bank of any proposed change of its authorised signatories or amendment to its Memorandum or Articles of Association or any other constitutional documents; and (ii) provide copies of board/member/shareholder resolutions or other corporate authorizations as required wherever appropriate on decisions which impact the Facilities.</p><br>";
				
				p++;
				
				external_details += "<br><b>"+p+"</b>. so long as any money is owing under the Agreement, it shall not without the prior written consent of the Bank undertake or permit any merger, bifurcation or re-organisation affecting the legal character of the Customer or the ownership or control over the management of the Customer. The Customer shall ensure that none of the shareholders of the Customer as at date of the Offer Letter transfers or sells their shares without prior written consent of the Bank.</p><br></ul>";
				
				
				
			}
			
			else if(mainCodeValue2.equals("0") && total_record_extlimit==0)
			{
				external_details="";
			}
			
			else
			{
				out.clear();
				out.print("ERROR - Error while fetching the data from external limit table");
				return;
			}
			
			String querySecurityDocTable = "select " +" "+ Security_Doc_ColName +" "+"from"+" " +SecurityGrid +" "+"with (nolock) where WINAME=:WI_NAME";
			logger.info("\nquerySecurityDocTable:\n"+querySecurityDocTable);
			params = "WI_NAME=="+winame;
			
			String inputXMLSecurity = "<?xml version='1.0'?><APSelectWithNamedParam_Input><Option>APSelectWithNamedParam</Option><Query>" + querySecurityDocTable + "</Query><Params>"+params+"</Params><EngineName>" + sCabName + "</EngineName><SessionId>" + sSessionId + "</SessionId></APSelectWithNamedParam_Input>";
			
			 logger.info("\n InputXML to get security conditions-->"+inputXMLSecurity);
			String outputXMLsecurity = WFCustomCallBroker.execute(inputXMLSecurity, sJtsIp, iJtsPort, 1);
			 logger.info("\n outputXML to get security conditions-->"+outputXMLsecurity);
			
			WFCustomXmlResponse xmlParserData7=new WFCustomXmlResponse();
			xmlParserData7.setXmlString((outputXMLsecurity));
			String mainCodeValue7 = xmlParserData7.getVal("MainCode");
			total_record_security = Integer.parseInt(xmlParserData7.getVal("TotalRetrieved"));
			
			WFCustomXmlResponse objXmlParser7=null;
			
			if(mainCodeValue7.equals("0") && total_record_security>0)
			{
				objWorkList = xmlParserData7.createList("Records","Record"); 
				int p=1;
				for(objWorkList.reInitialize(true);objWorkList.hasMoreElements(true);objWorkList.skip(true))
				{
					security_details +="<body style=font-family:verdana;font-size:"+13+">";	
					subXML = objWorkList.getVal("Record");
					objWFCustomXmlResponse = new WFCustomXmlResponse(subXML);	
					for(int j = 0; j < SecurityGridCol.length; ++j)
					{		
						mapsecurity.put(SecurityGridCol[j],objWFCustomXmlResponse.getVal(SecurityGridCol[j]));	
					}
						
					for (Map.Entry<String,String> entry : mapsecurity.entrySet()) 
					{
						String key = entry.getKey();
						String values = entry.getValue();
						logger.info("key for security--------->"+key);
						logger.info("values for security------->"+values);
						values = values.replaceAll("AMPNDCHAR","&");
						values = values.replaceAll("CCCOMMAAA",",");
						values = values.replaceAll("PPPERCCCENTT","%");
						if(!(values==null || values.equals("")))
						{
							if(p>=1)
							{
							
								security_details += "<p><b>"+p+"</b></p><p>"+"."+"</p><p>"+values+"<p><br>";
								p++;
								break;
							}
						}
					}
				}
				
			}
			
			else if(mainCodeValue7.equals("0") && total_record_security==0)
			{
				security_details="";
			}
			
			else
			{
				out.clear();
				//out.print("-6");
				out.print("ERROR - Error while fetching the data from security document table");
				return;
			}
			

			String queryFacilityGrid = "select" +" "+ facility_GridColName +" "+"from" +" "+Facility_GridTable+" "+ "with (nolock) where WINAME=:WI_NAME";
			logger.info("\nqueryFacilityGrid:\n"+queryFacilityGrid);
			params = "WI_NAME=="+winame;
			
			String inputXML6 = "<?xml version='1.0'?><APSelectWithNamedParam_Input><Option>APSelectWithNamedParam</Option><Query>" + queryFacilityGrid + "</Query><Params>"+params+"</Params><EngineName>" + sCabName + "</EngineName><SessionId>" + sSessionId + "</SessionId></APSelectWithNamedParam_Input>";
			
			 logger.info("\n InputXML to get facility type from facility grid-->"+inputXML6);
			String outputXML6 = WFCustomCallBroker.execute(inputXML6, sJtsIp, iJtsPort, 1);
			 logger.info("\n outputXML to get facility type from facility grid-->"+outputXML6);
			
			WFCustomXmlResponse xmlParserData6=new WFCustomXmlResponse();
			xmlParserData6.setXmlString((outputXML6));
			String mainCodeValue6 = xmlParserData6.getVal("MainCode");
			totalRecord=Integer.parseInt(xmlParserData6.getVal("TotalRetrieved"));
			
			WFCustomXmlResponse objXmlParser6=null;
			int b=1;
			

			 if(mainCodeValue6.equals("0") && totalRecord>0)
			{
				objWorkList = xmlParserData6.createList("Records","Record"); 
				logger.info("objWorkList"+objWorkList);
				for(objWorkList.reInitialize(true);objWorkList.hasMoreElements(true);objWorkList.skip(true))
				{
					subXML = objWorkList.getVal("Record");
					objWFCustomXmlResponse = new WFCustomXmlResponse(subXML);
					for(int j = 0; j < FacilityGridColumn.length; ++j)
					{
						//mapCheckfacility.clear();	
						mapCheckfacility.put(FacilityGridColumn[j],objWFCustomXmlResponse.getVal(FacilityGridColumn[j]));
					}
						for (Map.Entry<String,String> entry : mapCheckfacility.entrySet()) {
						String key = entry.getKey();
						String values = entry.getValue();
						logger.info("Key = " + key);
						logger.info("facility Values = " + values);
							
					}
						
					String queryFacilityMaster = "select" +" "+ Facility_ColumnName +" "+"from" +" "+FacilityMasterTable+" "+ "with (nolock) where FACILITY_TYPE=:FACILITY_TYPE";
					logger.info("\nqueryFacilityMaster:\n"+queryFacilityMaster);
					logger.info("Nature of facility is "+mapCheckfacility.get("NATURE_OF_FACILITY"));
					if(mapCheckfacility.get("NATURE_OF_FACILITY")==null || mapCheckfacility.get("NATURE_OF_FACILITY").equals(""))
					{
						logger.info("In if Sajan");
						continue;
					}
					params = "FACILITY_TYPE=="+mapCheckfacility.get("NATURE_OF_FACILITY");
					logger.info("nature of facility is"+mapCheckfacility.get("NATURE_OF_FACILITY"));
					
					String inputXML5 = "<?xml version='1.0'?><APSelectWithNamedParam_Input><Option>APSelectWithNamedParam</Option><Query>" + queryFacilityMaster + "</Query><Params>"+params+"</Params><EngineName>" + sCabName + "</EngineName><SessionId>" + sSessionId + "</SessionId></APSelectWithNamedParam_Input>";
					
					 logger.info("\n InputXML to get Facility Values from master-->"+inputXML5);
					String outputXML5 = WFCustomCallBroker.execute(inputXML5, sJtsIp, iJtsPort, 1);
					 logger.info("\n outputXML to get Facility Values from master-->"+outputXML5);
					
					WFCustomXmlResponse xmlParserData5=new WFCustomXmlResponse();
					xmlParserData5.setXmlString((outputXML5));
					String mainCodeValue5 = xmlParserData5.getVal("MainCode");
					
					WFCustomXmlResponse objXmlParser5=null;
					
					if(mainCodeValue5.equals("0"))
					{
						 for(int j = 0; j < FacilityColArray.length; ++j)
						{	
							//mapfacility.clear();
							mapfacility.put(FacilityColArray[j],xmlParserData5.getVal(FacilityColArray[j]));	
						}
						logger.info("Fetching Keys and corresponding [Multiple] Values");
						for (Map.Entry<String,String> entry : mapfacility.entrySet()) {
						String key = entry.getKey();
						String values = entry.getValue();
						logger.info("Key = " + key);
						logger.info("facility Values = " + values);
						}
					}  
					
					else
					{
						out.clear();
						//out.print("-2");
						out.print("ERROR - Error while fetching the data from facility master");
						return;
					}
							
					facility_details += "<ol start="+b+"><li style='font-weight:bold'><table border="+0+" style=font-family:verdana;font-size:"+13+">";
					facility_details += "<tr><td><b> Facility Type  </b></td><td><b>:</b>&nbsp;&nbsp;"+mapCheckfacility.get("NATURE_OF_FACILITY")+"</td></tr>";
					b++;
					for (Map.Entry<String,String> entry : mapfacility.entrySet()) 
					{
						String key = entry.getKey();
						key=convertToTitleCaseIteratingChars(key.replace("_"," "));
						String values = entry.getValue();
						if(!(values==null || values.equals("")))
						{
							logger.info("inside if loop");
							facility_details += "<tr><td><b>"+key+" </b></td><td><b>:</b>&nbsp;&nbsp;"+values+"</td></tr>";	
							
						}
					}
					facility_details += "</table></li>";
					facility_details += "<br/>";
					logger.info("Facility details as checked by Nikita--"+facility_details);
					
					
					for (Map.Entry<String,String> entry : mapCheckfacility.entrySet()) 
					{
						String key = entry.getKey();
						String values = entry.getValue();
						
						logger.info("facility detail html before replacing placeholder"+facility_details);
						facility_details = facility_details.replaceAll("<&"+key+"&>",values);
						if(facility_details.indexOf("<&FACILITY_SOUGHT_IN_WORDS&>") != -1)
						{
							if(key.equals("FACILITY_SOUGHT"))
							{
								double d=Double.parseDouble(values);
								values1=(int) d;
								//twc_temp = convert(values1); 
								twc_temp = convert(d);
								facility_details = facility_details.replaceAll("<&FACILITY_SOUGHT_IN_WORDS&>",twc_temp);
								 
							}
							
						}
							
						logger.info("facility_detail final --->"+facility_details);
					}
					facility_details+="<br/></ol>";
				}
				
			}

			else if(mainCodeValue6.equals("0")&&totalRecord==0)
			{
				facility_details="";
			}	
			
			else
			{
				out.clear();
				//out.print("-3");
				out.print("ERROR - Error while fetching the data from facility grid");
				return;
				
			}

			replacedString=replacedString.replaceAll("<&Letter Generation Date &>",mydate);
			replacedString=replacedString.replaceAll("<&FACILITY_DETAILS&>",facility_details);	
			replacedString=replacedString.replaceAll("<&General Conditions - Table data to be populated&>",general_details);  
			replacedString=replacedString.replaceAll("<&Special Covenants / Conditions External - Proposed Limits - Table data to be populated&>",external_details);
			replacedString=replacedString.replaceAll("<&Security Document Description from Security Document table will be displayed&>",security_details);
			
			
			OutputWriteString = writeFileFromServer(generateddocPath,replacedString);
			docxml = SearchExistingDoc(winame,FrmType,sCabName,sSessionId,sJtsIp,iJtsPort,generateddocPath,volumeid,Itemindex);
			logger.info("Final Document Output: "+docxml);
			documentindex = getTagValue(docxml,"DocumentIndex");
			doctype="new";
			logger.info(docxml+"~"+documentindex+"~"+doctype+"~"+dynamicPdfName);
			out.println(docxml+"~"+documentindex+"~"+doctype+"~"+dynamicPdfName);
			
		}
		catch (IOException e) 
		{
			e.printStackTrace();
		}
		
		catch (Exception e) {
		logger.info("Exception: "+e);
		out.println("NG110~"+docxml);
		out.println("ERROR : Problem in attaching document");
		}	
		
	}
	catch(Exception e)
	{
		e.printStackTrace();
		//sMappOutPutXML="Exception"+e;
		logger.info("in template generation.jsp final catch block");
		//logger.info(sMappOutPutXML);
	}
%>

